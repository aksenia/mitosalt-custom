# mitosalt-custom
A wrapper with enhancements around MitoSalt MT SV caller tool

# Quick start

Build Docker image

```bash
docker build -t mitosalt .
```

Build Singularity image if needed

```bash
singularity build mitosalt.sif docker-daemon://mitosalt:latest
```
Run the full MitoSAlt pipeline, please mind that pipeline expects you to mount to `/output`

```
# temp folders to explicitely provide to singularity 
mkdir -p tmp_home tmp

# output prefix
sample=$1
# read files basename (assuming they are located according to mount below)
R1=$2
R2=$3

singularity exec --no-home \
	--bind $(pwd)/tmp_home:/tmp_home \
	--bind $(pwd)/tmp:/tmp \
	--bind $(pwd)/data/reads/:/data \
	--bind $(pwd)/genome:/output/genome \ # genome ref and indices built according to MitoSAlt pipeline requirements
	--bind $(pwd)/output/${sample}:/output \ # this mount is needed
	--env HOME=/tmp_home,TMPDIR=/tmp \
	--pwd /output \
	mitosalt.sif  bash -c "cd /output && mkdir -p bam bin bw indel log plot tab \
			&& perl /opt/MitoSAlt_1.1.1/MitoSAlt1.1.1.pl \
				/opt/MitoSAlt_1.1.1/config_human.txt \
				/data/${R1} \
				/data/${R2} \
				${sample}"
```

or run the classifier and visualisation script separately on the outputs of MitoSAlt main pipeline (before the delplot.R script): 

```
# output prefix
sample=$1
# default settings from MitoSAlt config file
msize=16569
orihs=16081
orihe=407
orils=5730
orile=5763
sizelimit=10000
hplimit=0.01
MT_fasta=human_mt_rCRS.fasta
flank=15

singularity exec --no-home \
	--bind $(pwd)/data:/data \
	--bind $(pwd)/genome:/output/genome \
	--bind $(pwd)/output/${sample}:/output \
	--bind $(pwd)/output/${sample}:/tmp \
	mitosalt.sif bash -c "python /opt/MitoSAlt_1.1.1/mitosalt_visualizer.py \
			${msize} ${orihs} ${orihe} ${orils} ${orile} ${sizelimit} \
			/output/indel/${sample}.cluster /output/indel/${sample}.breakpoint \
			${sample} ${hplimit} /output/genome/${MT_fasta} ${flank} \
			--blacklist /output/genome/mt_blacklist.bed --output-dir /output"

```

## MitoSAlt Visualizer module

A Python port of the original MitoSAlt R plotting and classification script, with enhanced event pattern classification based on mitochondrial DNA literature.

## Overview

This tool ports the original MitoSAlt `delplot.R` script from R to Python, processing MitoSAlt pipeline output to:
- Classify mitochondrial DNA events as deletions or duplications (original R logic)
- Generate circular genome visualizations (original R plotting logic)
- Produce detailed analysis reports (original R output)
- **Enhanced**: classify overall patterns as single vs multiple events using literature-based criteria
- **Enhanced**: perform basic clustering to aid in classification and visual discrimination

The core deletion/duplication classification and visualization logic follows the original R implementation exactly. The additional pattern classification distinguishes between patient-like single high-heteroplasmy events and mouse model-like multiple low-heteroplasmy patterns based on the literature. Please cite [Basu et al. PLoS Genetics 2020](https://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1009242) if you are running full or partial MitoSAlt pipeline.

## Input files (from MitoSAlt pipeline)

### Required inputs

1. **Cluster file** (`.cluster`)
   - Contains clustered breakpoint information
   - Format: tab-separated with columns for cluster ID, reads, start/end positions, heteroplasmy levels
   - Generated by MitoSAlt's clustering step

2. **Breakpoint file** (`.breakpoint`) 
   - Contains raw breakpoint data for individual reads
   - Format: tab-separated including read names, positions, and d-loop crossing information
   - Generated by MitoSAlt's breakpoint detection step

3. **Reference genome fasta**
   - Mitochondrial reference genome sequence
   - Used for flanking sequence analysis and coordinate validation

### Optional inputs

4. **Blacklist file** (`.bed` format)
   - Regions to exclude from analysis (e.g., known artifacts, repetitive sequences)
   - Format: chromosome, start, end positions and name

## Key parameters

- **Genome length**: size of mitochondrial genome (e.g., 16569 for human)
- **Origin coordinates**: heavy strand (OriH) and light strand (OriL) replication origins
- **Heteroplasmy threshold**: minimum heteroplasmy level for event inclusion (default: 0.01)
- **Flanking sequence size**: base pairs around breakpoints for sequence analysis (default: 15)

## Analysis steps

### 1. Data loading and processing
```python
# Load cluster and breakpoint data (R script logic)
events = plotter.load_data(cluster_file, breakpoint_file, blacklist_file)
```
- Parses cluster and breakpoint files following original R script
- Merges data to link clusters with d-loop crossing information
- Calculates deletion sizes, handling wraparound events

### 2. Event classification (deletion vs duplication)
```python
# Apply origin-based classification (original R algorithm)
events = self._apply_origin_classification(events)
```
- **Algorithm**: based on overlap with replication origins (OriH and OriL)
- **Logic**: events overlapping origins are classified as duplications (arc complementary to deletion)
- **Implementation**: direct port of original R script classification logic

### 3. Pattern classification (single vs multiple) - **Enhanced**
```python
# Classify overall pattern (new Python enhancement)
classification, reason, criteria = self._classify_event_pattern(events)
```

**Single event pattern** (patient-like):
- Dominated by high-heteroplasmy events (â‰¥30%)
- Few major events (typically 1-3)
- Consistent with pathogenic single deletion/duplication

**Multiple event pattern** (mouse model-like):
- Many low-heteroplasmy events (<30%)
- High event counts (>20 events)
- Consistent with mtDNA maintenance defects

### 4. Visualization generation
```python
# Create circular genome plot (enhanced R script plotting logic)
plotter.create_plot(events, plot_file, blacklist_file=blacklist_file)
```
- **Circular representation** of mitochondrial genome (matches R output)
- **Color coding**: blue for deletions, red for duplications
- **Heteroplasmy intensity**: color intensity reflects heteroplasmy level
- **Spatial organization**: non-overlapping arcs with radius-based layering

### 5. Output generation
```python
# Generate detailed results (R script output format + clustering and blacklist-crossing labels)
plotter.save_results(events, results_file, genome_fasta, blacklist_file)

# Generate summary report (enhanced Python addition)
plotter.save_summary(events, summary_file, analysis_stats)
```

## Output files

### 1. Circular plot (`.png`)
- Visual representation of all detected events (matches R script output)
- Color-coded deletions (blue) and duplications (red)
- Heteroplasmy levels shown as color intensity
- Genome position markers and blacklisted regions

### 2. Detailed results (`.tsv`)
- Tab-separated file with comprehensive event information (R script format)
- Columns include: coordinates, heteroplasmy, event type, flanking sequences

### 3. Analysis summary (`.txt`) - **Enhanced**
- Human-readable analysis report with literature-based pattern classification
- Event classification and biological interpretation
- Heteroplasmy distribution analysis
- Statistical summary of detected events

## Usage

```bash
python mitosalt_visualizer.py \
    16569 \                   # genome length
    16081 407 \               # OriH coordinates  
    5730 5763 \               # OriL coordinate
    10000 \                   # size limit
    sample.cluster \          # cluster file
    sample.breakpoint \       # breakpoint file  
    sample_output \           # output prefix
    0.01 \                    # heteroplasmy threshold
    reference.fasta \         # MT genome fasta
    15 \                      # flanking sequence size
    --blacklist regions.bed \ # optional blacklist
    --output-dir results/     # output directory
```

## Dependencies

```python
pandas>=1.3.0
numpy>=1.20.0
matplotlib>=3.3.0
biopython>=1.78
pathlib
argparse
```

## Differences from original R script

### Core functionality (identical)
- Deletion/duplication classification algorithm
- Circular genome plotting
- Data processing and coordinate handling
- Output file formats and content

### Enhancements (Python additions)
- Literature-based pattern classification (single vs multiple events)
- Enhanced summary reports with biological interpretation
- Improved error handling and edge case management
- Additional clustering of the called events 
- Blacklist region visualization
